/*! backbone.paginator - v0.8.1 - 7/3/2013
* http://github.com/addyosmani/backbone.paginator
* Copyright (c) 2013 Addy Osmani; Licensed MIT */

Backbone.Paginator=function(e,t,i){var n=t.map(e.VERSION.split("."),function(e){return parseInt(e,10)}),s={};s.version="0.8.1",s.clientPager=e.Collection.extend({useDiacriticsPlugin:!0,useLevenshteinPlugin:!0,sortColumn:"",sortDirection:"desc",lastSortColumn:"",fieldFilterRules:[],lastFieldFilterRules:[],filterFields:"",filterExpression:"",lastFilterExpression:"",defaults_ui:{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4},initialize:function(){this.on("add",this.addModel,this),this.on("remove",this.removeModel,this),this.setDefaults()},setDefaults:function(){var e=t.defaults(this.paginator_ui,this.defaults_ui);t.defaults(this,e)},addModel:function(e){this.origModels.push(e)},removeModel:function(e){var i=t.indexOf(this.origModels,e);this.origModels.splice(i,1)},sync:function(s,r,o){var a=this;this.setDefaults();var l={};t.each(t.result(a,"server_api"),function(e,i){t.isFunction(e)&&(e=t.bind(e,a),e=e()),l[i]=e});var c=t.clone(a.paginator_core);t.each(c,function(e,i){t.isFunction(e)&&(e=t.bind(e,a),e=e()),c[i]=e}),c=t.defaults(c,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),c=t.extend(c,{data:decodeURIComponent(i.param(l)),processData:!1,url:t.result(c,"url")},o);var u=!(0===n[0]&&9===n[1]&&10===n[2]),h=c.success;c.success=function(e,t,i){h&&(u?h(e,t,i):h(r,e,c)),r&&r.trigger&&r.trigger("sync",r,e,c)};var d=c.error;c.error=function(e){d&&d(r,e,c),r&&r.trigger&&r.trigger("error",r,e,c)};var g=c.xhr=e.ajax(c);return r&&r.trigger&&r.trigger("request",r,g,c),g},nextPage:function(e){this.currentPage<this.information.totalPages&&(this.currentPage=++this.currentPage,this.pager(e))},previousPage:function(e){this.currentPage>1&&(this.currentPage=--this.currentPage,this.pager(e))},goTo:function(e,t){void 0!==e&&(this.currentPage=parseInt(e,10),this.pager(t))},howManyPer:function(e){if(void 0!==e){var t=this.perPage;this.perPage=parseInt(e,10),this.currentPage=Math.ceil((t*(this.currentPage-1)+1)/e),this.pager()}},setSort:function(e,t){void 0!==e&&void 0!==t&&(this.lastSortColumn=this.sortColumn,this.sortColumn=e,this.sortDirection=t,this.pager(),this.info())},setFieldFilter:function(e){t.isEmpty(e)?(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules="",this.pager(),this.info()):(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules=e,this.pager(),this.info())},doFakeFieldFilter:function(e){if(!t.isEmpty(e)){var i=this.origModels;return void 0===i&&(i=this.models),i=this._fieldFilter(i,e),""!==this.filterExpression&&(i=this._filter(i,this.filterFields,this.filterExpression)),i.length}},setFilter:function(e,t){void 0!==e&&void 0!==t&&(this.filterFields=e,this.lastFilterExpression=this.filterExpression,this.filterExpression=t,this.pager(),this.info())},doFakeFilter:function(e,i){if(void 0!==e&&void 0!==i){var n=this.origModels;return void 0===n&&(n=this.models),t.isEmpty(this.fieldFilterRules)||(n=this._fieldFilter(n,this.fieldFilterRules)),n=this._filter(n,e,i),n.length}},pager:function(e){var i=this,n=this.perPage,s=(i.currentPage-1)*n,r=s+n;void 0===i.origModels&&(i.origModels=i.models),i.models=i.origModels.slice(),""!==this.sortColumn&&(i.models=i._sort(i.models,this.sortColumn,this.sortDirection)),t.isEmpty(this.fieldFilterRules)||(i.models=i._fieldFilter(i.models,this.fieldFilterRules)),""!==this.filterExpression&&(i.models=i._filter(i.models,this.filterFields,this.filterExpression)),this.lastSortColumn===this.sortColumn&&this.lastFilterExpression===this.filterExpression&&t.isEqual(this.fieldFilterRules,this.lastFieldFilterRules)||(s=0,r=s+n,i.currentPage=1,this.lastSortColumn=this.sortColumn,this.lastFieldFilterRules=this.fieldFilterRules,this.lastFilterExpression=this.filterExpression),i.sortedAndFilteredModels=i.models.slice(),i.info(),i.reset(i.models.slice(s,r)),t.result(e,"success")},_sort:function(e,i,n){return e=e.sort(function(e,s){var r=e.get(i),o=s.get(i);if(t.isUndefined(r)||t.isUndefined(o)||null===r||null===o)return 0;if(r=r.toString().toLowerCase(),o=o.toString().toLowerCase(),"desc"===n)if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]+/)){if(o-0>r-0)return 1;if(r-0>o-0)return-1}else{if(o>r)return 1;if(r>o)return-1}else if(!r.match(/[^\-\d\.]/)&&r.match(/-?[\d\.]+/)&&!o.match(/[^\-\d\.]/)&&o.match(/-?[\d\.]+/)){if(o-0>r-0)return-1;if(r-0>o-0)return 1}else{if(o>r)return-1;if(r>o)return 1}if(e.cid&&s.cid){var a=e.cid,l=s.cid;if(l>a)return-1;if(a>l)return 1}return 0})},_fieldFilter:function(e,i){if(t.isEmpty(i))return e;var n=[];return t.each(e,function(e){var s=!0;t.each(i,function(i){if(!s)return!1;if(s=!1,"function"===i.type){var n=t.wrap(i.value,function(t){return t(e.get(i.field))});n()&&(s=!0)}else"required"===i.type?t.isEmpty(e.get(i.field).toString())||(s=!0):"min"===i.type?!t.isNaN(Number(e.get(i.field)))&&!t.isNaN(Number(i.value))&&Number(e.get(i.field))>=Number(i.value)&&(s=!0):"max"===i.type?!t.isNaN(Number(e.get(i.field)))&&!t.isNaN(Number(i.value))&&Number(e.get(i.field))<=Number(i.value)&&(s=!0):"range"===i.type?!t.isNaN(Number(e.get(i.field)))&&t.isObject(i.value)&&!t.isNaN(Number(i.value.min))&&!t.isNaN(Number(i.value.max))&&Number(e.get(i.field))>=Number(i.value.min)&&Number(e.get(i.field))<=Number(i.value.max)&&(s=!0):"minLength"===i.type?e.get(i.field).toString().length>=i.value&&(s=!0):"maxLength"===i.type?e.get(i.field).toString().length<=i.value&&(s=!0):"rangeLength"===i.type?t.isObject(i.value)&&!t.isNaN(Number(i.value.min))&&!t.isNaN(Number(i.value.max))&&e.get(i.field).toString().length>=i.value.min&&e.get(i.field).toString().length<=i.value.max&&(s=!0):"oneOf"===i.type?t.isArray(i.value)&&t.include(i.value,e.get(i.field))&&(s=!0):"equalTo"===i.type?i.value===e.get(i.field)&&(s=!0):"containsAllOf"===i.type?t.isArray(i.value)&&t.isArray(e.get(i.field))&&t.intersection(i.value,e.get(i.field)).length===i.value.length&&(s=!0):"pattern"===i.type?e.get(i.field).toString().match(i.value)&&(s=!0):s=!1}),s&&n.push(e)}),n},_filter:function(i,n,s){var r=this,o={};if(t.isString(n)?o[n]={cmp_method:"regexp"}:t.isArray(n)?t.each(n,function(e){o[e]={cmp_method:"regexp"}}):t.each(n,function(e,i){o[i]=t.defaults(e,{cmp_method:"regexp"})}),n=o,t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin&&(s=e.Paginator.removeDiacritics(s)),""===s||!t.isString(s))return i;var a=t.map(s.match(/\w+/gi),function(e){return e.toLowerCase()}),l="("+t.uniq(a).join("|")+")",c=new RegExp(l,"igm"),u=[];return t.each(i,function(i){var o=[];t.each(n,function(n,l){var u=i.get(l);if(u){var h=[];if(u=t.has(e.Paginator,"removeDiacritics")&&r.useDiacriticsPlugin?e.Paginator.removeDiacritics(u.toString()):u.toString(),"levenshtein"===n.cmp_method&&t.has(e.Paginator,"levenshtein")&&r.useLevenshteinPlugin){var d=e.Paginator.levenshtein(u,s);t.defaults(n,{max_distance:0}),d<=n.max_distance&&(h=t.uniq(a))}else h=u.match(c);h=t.map(h,function(e){return e.toString().toLowerCase()}),t.each(h,function(e){o.push(e)})}}),o=t.uniq(t.without(o,"")),t.isEmpty(t.difference(a,o))&&u.push(i)}),u},info:function(){var e=this,t={},i=e.sortedAndFilteredModels?e.sortedAndFilteredModels.length:e.length,n=Math.ceil(i/e.perPage);return t={totalUnfilteredRecords:e.origModels.length,totalRecords:i,currentPage:e.currentPage,perPage:this.perPage,totalPages:n,lastPage:n,previous:!1,next:!1,startRecord:0===i?0:(e.currentPage-1)*this.perPage+1,endRecord:Math.min(i,e.currentPage*this.perPage)},e.currentPage>1&&(t.previous=e.currentPage-1),e.currentPage<t.totalPages&&(t.next=e.currentPage+1),t.pageSet=e.setPagination(t),e.information=t,t},setPagination:function(e){var t=[],i=0,n=0,s=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+s>=r)for(i=1,n=r;n>=i;i++)t.push(i);else if(e.currentPage<=this.pagesInRange+1)for(i=1,n=2+s;n>i;i++)t.push(i);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(i=e.currentPage-this.pagesInRange;i<=e.currentPage+this.pagesInRange;i++)t.push(i);else for(i=r-s;r>=i;i++)t.push(i);return t},bootstrap:function(e){return t.extend(this,e),this.goTo(1),this.info(),this}}),s.clientPager.prototype.prevPage=s.clientPager.prototype.previousPage;var r=function(){var e=new i.Deferred;return e.reject(),e.promise()};return s.requestPager=e.Collection.extend({sync:function(s,r,o){var a=this;a.setDefaults();var l={};t.each(t.result(a,"server_api"),function(e,i){t.isFunction(e)&&(e=t.bind(e,a),e=e()),l[i]=e});var c=t.clone(a.paginator_core);t.each(c,function(e,i){t.isFunction(e)&&(e=t.bind(e,a),e=e()),c[i]=e}),c=t.defaults(c,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),o.data=decodeURIComponent(o.data?i.param(t.extend(l,o.data)):i.param(l)),c=t.extend(c,{data:decodeURIComponent(i.param(l)),processData:!1,url:t.result(c,"url")},o);var u=!(0===n[0]&&9===n[1]&&10===n[2]),h=c.success;c.success=function(e,t,i){h&&(u?h(e,t,i):h(r,e,c)),n[0]<1&&r&&r.trigger&&r.trigger("sync",r,e,c)};var d=c.error;c.error=function(e){d&&d(e),r&&r.trigger&&r.trigger("error",r,e,c)};var g=c.xhr=e.ajax(c);return r&&r.trigger&&r.trigger("request",r,g,c),g},setDefaults:function(){var e=this;t.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10,pagesInRange:4}),t.each(e.paginator_ui,function(i,n){t.isUndefined(e[n])&&(e[n]=e.paginator_ui[n])})},requestNextPage:function(e){return void 0!==this.currentPage?(this.currentPage+=1,this.pager(e)):r()},requestPreviousPage:function(e){return void 0!==this.currentPage?(this.currentPage-=1,this.pager(e)):r()},updateOrder:function(e,t){return void 0!==e?(this.sortField=e,this.pager(t)):r()},goTo:function(e,t){return void 0!==e?(this.currentPage=parseInt(e,10),this.pager(t)):r()},howManyPer:function(e,t){return void 0!==e?(this.currentPage=this.firstPage,this.perPage=e,this.pager(t)):r()},info:function(){var e={totalRecords:this.totalRecords||0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:Math.ceil(this.totalRecords/this.perPage),lastPage:this.totalPages,perPage:this.perPage,previous:!1,next:!1};return this.currentPage>1&&(e.previous=this.currentPage-1),this.currentPage<e.totalPages&&(e.next=this.currentPage+1),e.hasNext=e.next,e.hasPrevious=e.next,e.pageSet=this.setPagination(e),this.information=e,e},setPagination:function(e){var t=[],i=0,n=0,s=2*this.pagesInRange,r=Math.ceil(e.totalRecords/e.perPage);if(r>1)if(1+s>=r)for(i=1,n=r;n>=i;i++)t.push(i);else if(e.currentPage<=this.pagesInRange+1)for(i=1,n=2+s;n>i;i++)t.push(i);else if(r-this.pagesInRange>e.currentPage&&e.currentPage>this.pagesInRange)for(i=e.currentPage-this.pagesInRange;i<=e.currentPage+this.pagesInRange;i++)t.push(i);else for(i=r-s;r>=i;i++)t.push(i);return t},pager:function(e){return t.isObject(e)||(e={}),this.fetch(e)},url:function(){return void 0!==this.paginator_core&&void 0!==this.paginator_core.url?this.paginator_core.url:null},bootstrap:function(e){return t.extend(this,e),this.setDefaults(),this.info(),this}}),s.requestPager.prototype.nextPage=s.requestPager.prototype.requestNextPage,s.requestPager.prototype.prevPage=s.requestPager.prototype.requestPreviousPage,s}(Backbone,_,jQuery),RequireJS.define("backbone.paginator",["backbone"],function(e){return function(){var t;return t||e.Backbone.Paginator}}(this)),function(){RequireJS.define("common/js/components/collections/paging_collection",["backbone.paginator"],function(e){var t=e.requestPager.extend({initialize:function(){var e=this;this.sortableFields={},this.filterableFields={},this.paginator_core={type:"GET",dataType:"json",url:function(){return this.url}},this.paginator_ui={firstPage:function(){return e.isZeroIndexed?0:1},currentPage:e.isZeroIndexed?0:1,perPage:function(){return e.perPage}},this.currentPage=this.paginator_ui.currentPage,this.server_api={page:function(){return e.currentPage},page_size:function(){return e.perPage},text_search:function(){return e.searchString?e.searchString:""},sort_order:function(){return e.sortField}}},isZeroIndexed:!1,perPage:10,isStale:!1,sortField:"",sortDirection:"descending",sortableFields:{},filterField:"",filterableFields:{},searchString:null,parse:function(e){return this.totalCount=e.count,this.currentPage=e.current_page,this.totalPages=e.num_pages,this.start=e.start,e.sort_order&&(this.sortField=e.sort_order),e.results},getPage:function(){return this.currentPage+(this.isZeroIndexed?1:0)},setPage:function(e){var t=this.currentPage,i=this,n=$.Deferred();return this.goTo(e-(this.isZeroIndexed?1:0),{reset:!0}).then(function(){i.isStale=!1,i.trigger("page_changed"),n.resolve()},function(){i.currentPage=t,n.fail()}),n.promise()},refresh:function(){var e=$.Deferred();return this.isStale?this.setPage(1).done(function(){e.resolve()}):e.resolve(),e.promise()},hasNextPage:function(){return this.getPage()<this.totalPages},hasPreviousPage:function(){return this.getPage()>1},nextPage:function(){this.hasNextPage()&&this.setPage(this.getPage()+1)},previousPage:function(){this.hasPreviousPage()&&this.setPage(this.getPage()-1)},registerSortableField:function(e,t){this.addField(this.sortableFields,e,t)},registerFilterableField:function(e,t){this.addField(this.filterableFields,e,t)},addField:function(e,t,i){e[t]={displayName:i}},sortDisplayName:function(){return this.sortableFields[this.sortField].displayName},filterDisplayName:function(){return this.filterableFields[this.filterField].displayName},setSortField:function(e,i){i&&(this.sortDirection=this.sortField===e?t.SortDirection.flip(this.sortDirection):t.SortDirection.DESCENDING),this.sortField=e,this.isStale=!0},setSortDirection:function(e){this.sortDirection=e,this.isStale=!0},setFilterField:function(e){this.filterField=e,this.isStale=!0},setSearchString:function(e){e!==this.searchString&&(this.searchString=e,this.isStale=!0)}},{SortDirection:{ASCENDING:"ascending",DESCENDING:"descending",flip:function(e){return e===this.ASCENDING?this.DESCENDING:this.ASCENDING}}});return t})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/utils/utils",[],function(){var e=function(e){return(e+"").replace(/(\r\n|\n\r|\r|\n)/g,"<br>")};return{nl2br:e}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/models/note",["backbone","js/edxnotes/utils/utils","underscore.string"],function(e,t,i){var n=e.Model.extend({defaults:{id:null,created:"",updated:"",user:"",usage_id:"",course_id:"",text:"",quote:"",ranges:[],tags:[],unit:{display_name:"",url:"",location:""},section:{display_name:"",location:"",children:[]},chapter:{display_name:"",location:"",index:0,children:[]},is_expanded:!1,show_link:!1},textSize:300,initialize:function(){this.get("quote").length>this.textSize&&this.set("show_link",!0)},getQuote:function(){var e=this.get("quote");return!this.get("is_expanded")&&this.get("show_link")&&(e=i.prune(e,this.textSize)),e}});return n})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/collections/notes",["underscore","common/js/components/collections/paging_collection","js/edxnotes/models/note"],function(e,t,i){return t.extend({model:i,initialize:function(i,n){t.prototype.initialize.call(this),this.perPage=n.perPage,this.server_api=e.pick(this.server_api,"page","page_size"),n.text&&(this.server_api.text=n.text)},getCourseStructure:function(){var t=null;return function(){var i={},n={},s={};return this.each(function(e){var t=e.get("chapter"),r=e.get("section"),o=e.get("unit");i[t.location]=t,n[r.location]=r,s[o.location]=s[o.location]||[],s[o.location].push(e)}),t={chapters:e.sortBy(e.toArray(i),function(e){return e.index}),sections:n,units:s}}}()})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/utils/logger",["underscore","logger"],function(e,t){var i,n,s,r=[];return n=function(){return performance&&performance.now?performance.now():Date.now?Date.now():(new Date).getTime()},s=function(e){for(var t,i=r.length;i--;)if(r[i].id===e.id){t=r.splice(i,1)[0],t.historyStorage=[],t.timeStorage={};break}},i=function(e,t){this.id=e,this.historyStorage=[],this.timeStorage={},this.logLevel=t},i.prototype._log=function(e,t){return this.logLevel?(this.updateHistory.apply(this,arguments),Array.prototype.unshift.call(t,this.id),void(console&&console[e]&&(console[e].apply?console[e].apply(console,t):console[e](t.join(" "))))):!1},i.prototype.log=function(){this._log("log",arguments)},i.prototype.error=function(){this._log("error",arguments)},i.prototype.updateHistory=function(){this.historyStorage.push(arguments)},i.prototype.getHistory=function(){return this.historyStorage},i.prototype.time=function(e){this.timeStorage[e]=n()},i.prototype.timeEnd=function(e){return this.timeStorage[e]?(this._log("log",[e,n()-this.timeStorage[e],"ms"]),void delete this.timeStorage[e]):null},i.prototype.destroy=function(){s(this)},i.prototype.emit=function(e,i,n){var s=[e,i];return this.log(e,i),n&&s.push(null,{timeout:n}),t.log.apply(t,s)},{getLogger:function(e,t){var n=new i(e,t);return r.push(n),n},destroyLogger:s}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/models/tab",["underscore","backbone","js/edxnotes/utils/logger"],function(e,t,i){var n=t.Model.extend({defaults:{identifier:"",name:"",icon:"",is_active:!1,is_closable:!1,view:""},initialize:function(){this.logger=i.getLogger("tab")},activate:function(){this.collection.each(e.bind(function(e){e!==this&&e.inactivate()},this)),this.set("is_active",!0),this.logger.emit("edx.course.student_notes.notes_page_viewed",{view:this.get("view")})},inactivate:function(){this.set("is_active",!1)},isActive:function(){return this.get("is_active")}});return n})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/collections/tabs",["backbone","js/edxnotes/models/tab"],function(e,t){var i=e.Collection.extend({model:t});return i})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/utils/template",["jquery","underscore"],function(e,t){var i=function(i){var n="#"+i+"-tpl",s=e(n).text();return s||console.error("Failed to load "+i+" template"),t.template(s)};return{loadTemplate:i}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tab_item",["gettext","underscore","jquery","backbone","js/edxnotes/utils/template"],function(e,t,i,n,s){var r=n.View.extend({tagName:"li",className:"tab",activeClassName:"is-active",events:{click:"selectHandler","click a":function(e){e.preventDefault()},"click .action-close":"closeHandler"},initialize:function(){this.template=s.loadTemplate("tab-item"),this.$el.attr("id",this.model.get("identifier")),this.listenTo(this.model,{"change:is_active":function(t,n){this.$el.toggleClass(this.activeClassName,n),n?this.$(".tab-label").prepend(i("<span />",{"class":"tab-aria-label sr",text:e("Current tab")})):this.$(".tab-aria-label").remove()},destroy:this.remove})},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this},selectHandler:function(e){e.preventDefault(),this.model.isActive()||this.model.activate()},closeHandler:function(e){e.preventDefault(),e.stopPropagation(),this.model.destroy()}});return r})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tabs_list",["underscore","backbone","js/edxnotes/views/tab_item"],function(e,t,i){var n=t.View.extend({tagName:"ul",className:"tabs",initialize:function(e){this.options=e,this.listenTo(this.collection,{add:this.createTab,destroy:function(e,t){e.isActive()&&t.length&&t.at(0).activate()}})},render:function(){return this.collection.each(this.createTab,this),this.collection.length&&this.collection.at(0).activate(),this},createTab:function(e){var t=new i({model:e});return t.render().$el.appendTo(this.$el),t}});return n})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/note_item",["jquery","underscore","backbone","js/edxnotes/utils/template","js/edxnotes/utils/logger"],function(e,t,i,n,s){var r=i.View.extend({tagName:"article",className:"note",id:function(){return"note-"+t.uniqueId()},events:{"click .note-excerpt-more-link":"moreHandler","click .reference-unit-link":"unitLinkHandler","click .reference-tags":"tagHandler"},initialize:function(e){this.template=n.loadTemplate("note-item"),this.logger=s.getLogger("note_item",e.debug),this.listenTo(this.model,"change:is_expanded",this.render)},render:function(){var e=this.getContext();return this.$el.html(this.template(e)),this},getContext:function(){return e.extend({},this.model.toJSON(),{message:this.model.getQuote()})},toggleNote:function(){var e=!this.model.get("is_expanded");this.model.set("is_expanded",e)},moreHandler:function(e){e.preventDefault(),this.toggleNote()},unitLinkHandler:function(e){var i=2e3;e.preventDefault(),this.logger.emit("edx.course.student_notes.used_unit_link",{note_id:this.model.get("id"),component_usage_id:this.model.get("usage_id"),view:this.options.view},i).always(t.bind(function(){this.redirectTo(e.target.href)},this))},tagHandler:function(e){e.preventDefault(),t.isUndefined(this.options.scrollToTag)||this.options.scrollToTag(e.currentTarget.text)},redirectTo:function(e){window.location=e},remove:function(){return this.logger.destroy(),i.View.prototype.remove.call(this),this}});return r})}.call(this,define||RequireJS.define),RequireJS.define("text",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),RequireJS.define("text!common/templates/components/paging-header.underscore",[],function(){return'<% if (!_.isUndefined(srInfo)) { %>\n  <h2 class="sr" id="<%= srInfo.id %>"><%- srInfo.text %></h2>\n<% } %>\n<div class="search-tools listing-tools">\n    <span class="search-count listing-count">\n        <%= message %>\n    </span>\n    <% if (showSortControls) { %>\n      |\n      <span class="field listing-sort">\n          <label class="field-label" for="paging-header-select"><%- gettext("Sorted by") %></label>\n          <select id="paging-header-select" name="paging-header-select" class="field-input input-select listing-sort-select">\n              <% _.each(sortableFields, function (option, key) { %>\n                <option value="<%= key %>" <% if (key === sortOrder) { %> selected="true" <% } %>>\n                  <%- option.displayName %>\n                </option>\n              <% }) %>\n          </select>\n      </span>\n    <% } %>\n</div>\n'}),function(){RequireJS.define("common/js/components/views/paging_header",["backbone","underscore","gettext","text!common/templates/components/paging-header.underscore"],function(e,t,i,n){var s=e.View.extend({initialize:function(e){this.srInfo=e.srInfo,this.showSortControls=e.showSortControls,this.collection.bind("add",t.bind(this.render,this)),this.collection.bind("remove",t.bind(this.render,this)),this.collection.bind("reset",t.bind(this.render,this))},events:{"change #paging-header-select":"sortCollection"},render:function(){var e,s=t.isUndefined(this.collection.start)?0:this.collection.start,r=s+this.collection.length,o=t.isUndefined(this.collection.totalCount)?0:this.collection.totalCount,a={first_index:Math.min(s+1,r),last_index:r,num_items:o};return e=1>=r?interpolate(i("Showing %(first_index)s out of %(num_items)s total"),a,!0):interpolate(i("Showing %(first_index)s-%(last_index)s out of %(num_items)s total"),a,!0),this.$el.html(t.template(n)({message:e,srInfo:this.srInfo,sortableFields:this.collection.sortableFields,sortOrder:this.sortOrder,showSortControls:this.showSortControls})),this},sortCollection:function(){var e=this.$("#paging-header-select option:selected");return this.sortOrder=e.attr("value"),this.collection.setSortField(this.sortOrder),this.collection.refresh()}});return s})}.call(this,define||RequireJS.define),RequireJS.define("text!common/templates/components/paging-footer.underscore",[],function(){return'<nav class="pagination pagination-full bottom" aria-label="<%= paginationLabel %>">\n    <div class="nav-item previous"><button class="nav-link previous-page-link"><i class="icon fa fa-angle-left" aria-hidden="true"></i> <span class="nav-label"><%= gettext("Previous") %></span></button></div>\n    <div class="nav-item page">\n        <div class="pagination-form">\n            <label class="page-number-label" for="page-number-input"><%= interpolate(\n                    gettext("Page number out of %(total_pages)s"),\n                    {total_pages: total_pages},\n                    true\n                )%></label>\n            <input id="page-number-input" class="page-number-input" name="page-number" type="text" size="4" autocomplete="off" aria-describedby="page-number-input-helper"/>\n            <span class="sr field-helper" id="page-number-input-helper"><%= gettext("Enter the page number you\'d like to quickly navigate to.") %></span>\n        </div>\n\n        <span class="current-page"><%= current_page %></span>\n        <span class="sr">&nbsp;out of&nbsp;</span>\n        <span class="page-divider" aria-hidden="true">/</span>\n        <span class="total-pages"><%= total_pages %></span>\n    </div>\n    <div class="nav-item next"><button class="nav-link next-page-link"><span class="nav-label"><%= gettext("Next") %></span> <i class="icon fa fa-angle-right" aria-hidden="true"></i></button></div>\n</nav>\n'}),function(){RequireJS.define("common/js/components/views/paging_footer",["underscore","gettext","backbone","text!common/templates/components/paging-footer.underscore"],function(e,t,i,n){var s=i.View.extend({events:{"click .next-page-link":"nextPage","click .previous-page-link":"previousPage","change .page-number-input":"changePage"},initialize:function(i){this.collection=i.collection,this.hideWhenOnePage=i.hideWhenOnePage||!1,this.paginationLabel=i.paginationLabel||t("Pagination"),this.collection.bind("add",e.bind(this.render,this)),this.collection.bind("remove",e.bind(this.render,this)),this.collection.bind("reset",e.bind(this.render,this)),this.render()},render:function(){var t=!this.collection.hasPreviousPage(),i=!this.collection.hasNextPage();return this.hideWhenOnePage&&(e.isUndefined(this.collection.totalPages)||this.collection.totalPages<=1?this.$el.addClass("hidden"):this.$el.hasClass("hidden")&&this.$el.removeClass("hidden")),this.$el.html(e.template(n)({current_page:this.collection.getPage(),total_pages:this.collection.totalPages,paginationLabel:this.paginationLabel})),this.$(".previous-page-link").toggleClass("is-disabled",t).attr("aria-disabled",t),this.$(".next-page-link").toggleClass("is-disabled",i).attr("aria-disabled",i),this},changePage:function(){var e=this.collection,t=e.getPage(),i=this.$("#page-number-input"),n=parseInt(i.val(),10),s=!0;(!n||n>e.totalPages||1>n)&&(s=!1),s&&n!==t&&e.setPage(n),i.val("")},nextPage:function(){this.collection.nextPage()},previousPage:function(){this.collection.previousPage()}});return s})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tab_panel",["gettext","underscore","backbone","js/edxnotes/views/note_item","common/js/components/views/paging_header","common/js/components/views/paging_footer"],function(e,t,i,n,s,r){var o=i.View.extend({tagName:"section",className:"tab-panel",title:"",titleTemplate:t.template('<h2 class="sr"><%- text %></h2>'),attributes:{tabindex:-1},initialize:function(){this.children=[],this.options.createHeaderFooter&&(this.pagingHeaderView=new s({collection:this.collection}),this.pagingFooterView=new r({collection:this.collection,hideWhenOnePage:!0})),this.hasOwnProperty("collection")&&this.listenTo(this.collection,"page_changed",this.render)},render:function(){return this.$el.html(this.getTitle()),this.renderView(this.pagingHeaderView),this.renderContent(),this.renderView(this.pagingFooterView),this},renderView:function(e){this.options.createHeaderFooter&&this.collection.models.length&&(this.$el.append(e.render().el),e.delegateEvents())},renderContent:function(){return this},getNotes:function(e){var i=document.createDocumentFragment(),s=this.options.scrollToTag,r=this.title,o=t.map(e,function(e){var t=new n({model:e,scrollToTag:s,view:r});return i.appendChild(t.render().el),t});return this.children=this.children.concat(o),i},getTitle:function(){return this.title?this.titleTemplate({text:e(this.title)}):""},remove:function(){return t.invoke(this.children,"remove"),this.children=null,i.View.prototype.remove.call(this),this}});return o})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tab_view",["jquery","underscore","backbone","js/edxnotes/models/tab"],function(e,t,i,n){var s=i.View.extend({PanelConstructor:null,tabInfo:{name:"",class_name:""},initialize:function(e){t.bindAll(this,"showLoadingIndicator","hideLoadingIndicator"),this.options=t.defaults(e||{},{createTabOnInitialization:!0,createHeaderFooter:!0}),this.options.createTabOnInitialization&&this.createTab()},createTab:function(){this.tabModel=new n(this.tabInfo),this.options.tabsCollection.add(this.tabModel),this.listenTo(this.tabModel,{"change:is_active":function(e,t){t?this.render():this.destroySubView()},destroy:function(){this.destroySubView(),this.tabModel=null,this.onClose()}})},render:function(){return this.hideErrorMessage().showLoadingIndicator(),this.destroySubView(),this.renderContent().always(this.hideLoadingIndicator),this.$(".sr-is-focusable.sr-tab-panel").focus(),this},renderContent:function(){return this.contentView=this.getSubView(),this.$(".wrapper-tabs").append(this.contentView.render().$el),e.Deferred().resolve().promise()},getSubView:function(){var e=this.getCollection();return new this.PanelConstructor({collection:e,scrollToTag:this.options.scrollToTag,createHeaderFooter:this.options.createHeaderFooter})},destroySubView:function(){this.contentView&&(this.contentView.remove(),this.contentView=null)},getCollection:function(){return this.collection},onClose:function(){},getLoadingIndicator:function(){return this.$(".ui-loading")},showLoadingIndicator:function(){return this.getLoadingIndicator().removeClass("is-hidden"),this},hideLoadingIndicator:function(){return this.getLoadingIndicator().addClass("is-hidden"),this},showErrorMessage:function(e){return this.$(".wrapper-msg").removeClass("is-hidden").find(".msg-content .copy").html(e),this},hideErrorMessage:function(){return this.$(".wrapper-msg").addClass("is-hidden").find(".msg-content .copy").html(""),this}});return s})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tabs/recent_activity",["gettext","js/edxnotes/views/tab_panel","js/edxnotes/views/tab_view"],function(e,t,i){var n="Recent Activity",s=i.extend({PanelConstructor:t.extend({id:"recent-panel",title:n,className:function(){return[t.prototype.className,"note-group"].join(" ")},renderContent:function(){return this.$el.append(this.getNotes(this.collection.toArray())),this}}),tabInfo:{identifier:"view-recent-activity",name:e("Recent Activity"),icon:"fa fa-clock-o",view:n}});return s})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/note_group",["gettext","underscore","backbone"],function(e,t,i){var n,s;return n=i.View.extend({tagName:"section",id:function(){return"note-section-"+t.uniqueId()},initialize:function(){this.template=t.template(this.options.template),this.className=this.options.className},render:function(){return this.$el.prepend(this.template({displayName:this.options.displayName})),this},addChild:function(e){this.$el.append(e)}}),s=i.View.extend({tagName:"section",className:"note-group",id:function(){return"note-group-"+t.uniqueId()},template:t.template('<h3 class="course-title"><%- chapterName %></h3>'),initialize:function(){this.children=[]},render:function(){var e=document.createDocumentFragment();return this.$el.html(this.template({chapterName:this.options.chapter.display_name||""})),t.each(this.children,function(t){e.appendChild(t.render().el)}),this.$el.append(e),this},addChild:function(e){var t=new n({displayName:e.display_name,template:'<h4 class="course-subtitle"><%- displayName %></h4>',className:"note-section"});return this.children.push(t),t},remove:function(){return t.invoke(this.children,"remove"),this.children=null,i.View.prototype.remove.call(this),this
}}),{GroupView:n,ChapterView:s}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tabs/course_structure",["gettext","underscore","js/edxnotes/views/note_group","js/edxnotes/views/tab_panel","js/edxnotes/views/tab_view"],function(e,t,i,n,s){var r="Location in Course",o=s.extend({PanelConstructor:n.extend({id:"structure-panel",title:r,renderContent:function(){var e=this.collection.getCourseStructure(),i=document.createDocumentFragment();return t.each(e.chapters,function(n){var s=this.getChapterGroupView(n);t.each(n.children,function(i){var n,r=e.sections[i];r&&(n=s.addChild(r),t.each(r.children,function(t){var i=e.units[t];i&&n.addChild(this.getNotes(i))},this))},this),i.appendChild(s.render().el)},this),this.$el.append(i),this},getChapterGroupView:function(e,t){var n=new i.ChapterView({chapter:e,section:t});return this.children.push(n),n}}),tabInfo:{name:e("Location in Course"),identifier:"view-course-structure",icon:"fa fa-list-ul",view:r}});return o})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/search_box",["jquery","underscore","backbone","gettext","js/edxnotes/utils/logger","js/edxnotes/collections/notes"],function(e,t,i,n,s,r){var o=i.View.extend({events:{submit:"submitHandler"},errorMessage:n("An error has occurred. Make sure that you are connected to the Internet, and then try refreshing the page."),emptyFieldMessage:function(){var e=n("Please enter a term in the %(anchor_start)s search field%(anchor_end)s.");return interpolate(e,{anchor_start:'<a href="#search-notes-input">',anchor_end:"</a>"},!0)}(),initialize:function(e){t.bindAll(this,"onSuccess","onError","onComplete"),this.options=t.defaults(e||{},{beforeSearchStart:function(){},search:function(){},error:function(){},complete:function(){}}),this.logger=s.getLogger("search_box",this.options.debug),this.$el.removeClass("is-hidden"),this.isDisabled=!1,this.searchInput=this.$el.find("#search-notes-input"),this.logger.log("initialized")},clearInput:function(){this.searchInput.val("")},submitHandler:function(e){e.preventDefault(),this.search()},prepareData:function(e){return e&&t.has(e,"count")&&t.has(e,"results")?[this.collection,this.searchQuery]:(this.logger.log("Wrong data",e,this.searchQuery),null)},getSearchQuery:function(){return this.$el.find("#search-notes-input").val()},search:function(){return this.isDisabled?!1:(this.searchQuery=this.getSearchQuery(),this.validateField(this.searchQuery)?(this.options.beforeSearchStart(this.searchQuery),this.disableForm(),this.sendRequest(this.searchQuery).done(this.onSuccess).fail(this.onError).complete(this.onComplete),!0):!1)},validateField:function(t){return e.trim(t)?!0:(this.options.error(this.emptyFieldMessage,t),!1)},onSuccess:function(e){var t=this.prepareData(e);t?(this.options.search.apply(this,t),this.logger.emit("edx.course.student_notes.searched",{number_of_results:t[0].totalCount,search_string:t[1]})):this.options.error(this.errorMessage,this.searchQuery)},onError:function(t){var i,n=this.getSearchQuery();if(t.responseText)try{i=e.parseJSON(t.responseText).error}catch(s){}this.options.error(i||this.errorMessage,n),this.logger.log("Response fails",t.responseText)},onComplete:function(){this.enableForm(),this.options.complete(this.searchQuery)},enableForm:function(){this.isDisabled=!1,this.$el.removeClass("is-looking"),this.$("button[type=submit]").removeClass("is-disabled")},disableForm:function(){this.isDisabled=!0,this.$el.addClass("is-looking"),this.$("button[type=submit]").addClass("is-disabled")},sendRequest:function(e){return this.collection=new r([],{text:e,perPage:this.options.perPage,url:this.el.action}),this.collection.goTo(1)}});return o})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/tabs/search_results",["jquery","underscore","gettext","js/edxnotes/views/tab_panel","js/edxnotes/views/tab_view","js/edxnotes/views/search_box"],function(e,t,i,n,s,r){var o="Search Results",a=s.extend({PanelConstructor:n.extend({id:"search-results-panel",title:o,className:function(){return[n.prototype.className,"note-group"].join(" ")},renderContent:function(){return this.$el.append(this.getNotes(this.collection.toArray())),this}}),NoResultsViewConstructor:n.extend({id:"no-results-panel",title:"No results found",className:function(){return[n.prototype.className,"note-group"].join(" ")},renderContent:function(){var t=i('No results found for "%(query_string)s". Please try searching again.');return this.$el.append(e("<p />",{text:interpolate(t,{query_string:this.options.searchQuery},!0)})),this}}),tabInfo:{identifier:"view-search-results",name:i("Search Results"),icon:"fa fa-search",is_closable:!0,view:o},initialize:function(e){t.bindAll(this,"onBeforeSearchStart","onSearch","onSearchError"),s.prototype.initialize.call(this,e),this.searchResults=null,this.searchBox=new r({el:document.getElementById("search-notes-form"),debug:this.options.debug,perPage:this.options.perPage,beforeSearchStart:this.onBeforeSearchStart,search:this.onSearch,error:this.onSearchError})},renderContent:function(){return this.getLoadingIndicator().focus(),this.searchPromise.done(t.bind(function(){this.contentView=this.getSubView(),this.contentView&&this.$(".wrapper-tabs").append(this.contentView.render().$el)},this))},getSubView:function(){var e=this.getCollection();return e?e.length?new this.PanelConstructor({collection:e,searchQuery:this.searchResults.searchQuery,scrollToTag:this.options.scrollToTag,createHeaderFooter:this.options.createHeaderFooter}):new this.NoResultsViewConstructor({searchQuery:this.searchResults.searchQuery}):null},getCollection:function(){return this.searchResults?this.searchResults.collection:null},onClose:function(){this.searchResults=null,this.searchBox.clearInput()},onBeforeSearchStart:function(){this.searchDeferred=e.Deferred(),this.searchPromise=this.searchDeferred.promise(),this.hideErrorMessage(),this.searchResults=null,this.tabModel||this.createTab(),this.tabModel.isActive()?this.render():this.tabModel.activate()},onSearch:function(e,t){this.searchResults={collection:e,searchQuery:t},this.searchDeferred&&this.searchDeferred.resolve(),this.contentView&&this.contentView.$el.focus()},onSearchError:function(e){this.showErrorMessage(e),this.searchDeferred&&this.searchDeferred.reject()}});return a})}.call(this,define||RequireJS.define),function(e,t){RequireJS.define("js/edxnotes/views/tabs/tags",["gettext","jquery","underscore","js/edxnotes/views/note_group","js/edxnotes/views/tab_panel","js/edxnotes/views/tab_view"],function(e,i,n,s,r,o){var a="Tags",l=o.extend({scrollToTag:function(e){var t,n;this.tabModel.isActive()||this.tabModel.activate(),n=this.contentView.titleMap[e.toLowerCase()],t=this.$el.find(".tags-title").filter(function(){return i(this).text()===n}),i("html,body").animate({scrollTop:t.offset().top-10},"slow",function(){t.focus()})},initialize:function(e){o.prototype.initialize.call(this,e),n.bindAll(this,"scrollToTag"),this.options.scrollToTag=this.scrollToTag},PanelConstructor:r.extend({id:"tags-panel",title:a,noTags:e("[no tags]"),renderContent:function(){var e,i,s,r,o,a,l,c,u,h={},d=this.noTags;return e=function(e,n){i=h[n.toLowerCase()],i===t&&(i=[],h[n.toLowerCase()]=i),(0===i.length||i[i.length-1]!==e)&&i.push(e)},this.collection.each(function(t){if(s=t.get("tags"),0===s.length)e(t,d);else for(r=0;r<s.length;r++)e(t,s[r])}),o=Object.keys(h).sort(function(e,t){return e===d?1:t===d?-1:h[e].length>h[t].length?-1:h[e].length<h[t].length?1:e.toLowerCase()<=t.toLowerCase()?-1:1}),a=document.createDocumentFragment(),this.titleMap={},u=this.titleMap,n.each(o,function(e){c=h[e];var t=interpolate_text("{tagName} ({numberOfNotesWithTag})",{tagName:e,numberOfNotesWithTag:c.length});l=this.getGroup(t),u[e]=t,l.addChild(this.getNotes(c)),a.appendChild(l.render().el)},this),this.$el.append(a),this},getGroup:function(e){var t=new s.GroupView({displayName:e,template:'<h3 class="tags-title sr-is-focusable" tabindex="-1"><%- displayName %></h3>',className:"note-group"});return this.children.push(t),t}}),tabInfo:{name:e("Tags"),identifier:"view-tags",icon:"fa fa-tag",view:a}});return l})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/notes_page",["backbone","js/edxnotes/collections/tabs","js/edxnotes/views/tabs_list","js/edxnotes/views/tabs/recent_activity","js/edxnotes/views/tabs/course_structure","js/edxnotes/views/tabs/search_results","js/edxnotes/views/tabs/tags"],function(e,t,i,n,s,r,o){var a=e.View.extend({initialize:function(e){var a,l;this.options=e,this.tabsCollection=new t,_.contains(this.options.disabledTabs,"tags")||(this.tagsView=new o({el:this.el,collection:this.collection,tabsCollection:this.tabsCollection}),a=this.tagsView.scrollToTag,l=this.tabsCollection.shift()),this.recentActivityView=new n({el:this.el,collection:this.collection,tabsCollection:this.tabsCollection,scrollToTag:a}),_.contains(this.options.disabledTabs,"course_structure")||(this.courseStructureView=new s({el:this.el,collection:this.collection,tabsCollection:this.tabsCollection,scrollToTag:a})),_.contains(this.options.disabledTabs,"tags")||this.tabsCollection.push(l),this.searchResultsView=new r({el:this.el,tabsCollection:this.tabsCollection,debug:this.options.debug,perPage:this.options.perPage,createTabOnInitialization:!1,scrollToTag:a}),this.tabsView=new i({collection:this.tabsCollection}),this.$(".tab-list").append(this.tabsView.render().$el).removeClass("is-hidden")}});return a})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/page_factory",["jquery","js/edxnotes/collections/notes","js/edxnotes/views/notes_page"],function(e,t,i){return function(n){var s=new t(n.notes,{url:n.notesEndpoint,perPage:n.pageSize,parse:!0});return new i({el:e(".wrapper-student-notes").get(0),collection:s,debug:n.debugMode,perPage:n.pageSize,disabledTabs:n.disabledTabs})}})}.call(this,define||RequireJS.define);